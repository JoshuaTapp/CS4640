<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Exceptions &amp; Context Switching</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	text-indent: -1.7em;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
}

.simple-table-header {
	background: rgb(247, 246, 243);
	color: black;
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-opaquegray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="ec98067a-5180-4a01-96c7-f80acb71d903" class="page sans"><header><h1 class="page-title">Exceptions &amp; Context Switching</h1><table class="properties"><tbody><tr class="property-row property-row-created_time"><th><span class="icon property-icon"><svg viewBox="0 0 14 14" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" class="typesCreatedAt"><path d="M6.98643729,14.0000972 C5.19579566,14.0000972 3.40419152,13.3106896 2.04245843,11.9323606 C-0.681017475,9.21200555 -0.680780251,4.76029539 2.04293482,2.04012507 C4.76664406,-0.68004331 9.22427509,-0.68004331 11.9480135,2.04013479 C13.272481,3.36277455 14,5.1330091 14,6.99552762 C14,8.87640182 13.2721894,10.6285043 11.9480135,11.9509302 C10.5679344,13.3105924 8.77756503,14.0000972 6.98643729,14.0000972 Z M10.2705296,7.00913883 L10.2705296,8.46099754 L10.2705296,8.65543362 L10.076181,8.65543362 L8.6543739,8.65543362 L5.72059514,8.65543362 L5.52619796,8.65543362 L5.52619796,8.46099754 L5.52619796,5.52541044 L5.52619796,3.37946773 L5.52619796,3.18502193 L5.72059514,3.18502193 L7.17253164,3.18502193 L7.36692883,3.18502193 L7.36692883,3.37946773 L7.36692883,6.81467358 L10.076181,6.81467358 L10.2705296,6.81467358 L10.2705296,7.00913883 Z M12.1601539,6.99552762 C12.1601539,5.61697497 11.6190112,4.32597154 10.6393933,3.34769528 C8.63253764,1.34336744 5.35197452,1.34061603 3.34153136,3.33944106 C3.33868273,3.34219247 3.33607716,3.34494388 3.33322852,3.34769528 C1.32397148,5.35459953 1.32372842,8.63641682 3.33322852,10.6433794 C5.34295224,12.6504489 8.62968901,12.6504489 10.6393933,10.6433794 C11.6190112,9.66506426 12.1601539,8.37408027 12.1601539,6.99552762 Z"></path></svg></span>Created</th><td><time>@January 30, 2022 3:23 PM</time></td></tr><tr class="property-row property-row-select"><th><span class="icon property-icon"><svg viewBox="0 0 14 14" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" class="typesSelect"><path d="M7,13 C10.31348,13 13,10.31371 13,7 C13,3.68629 10.31348,1 7,1 C3.68652,1 1,3.68629 1,7 C1,10.31371 3.68652,13 7,13 Z M3.75098,5.32278 C3.64893,5.19142 3.74268,5 3.90869,5 L10.09131,5 C10.25732,5 10.35107,5.19142 10.24902,5.32278 L7.15771,9.29703 C7.07764,9.39998 6.92236,9.39998 6.84229,9.29703 L3.75098,5.32278 Z"></path></svg></span>Class</th><td><span class="selected-value select-value-color-green">CS4144</span></td></tr><tr class="property-row property-row-select"><th><span class="icon property-icon"><svg viewBox="0 0 14 14" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" class="typesSelect"><path d="M7,13 C10.31348,13 13,10.31371 13,7 C13,3.68629 10.31348,1 7,1 C3.68652,1 1,3.68629 1,7 C1,10.31371 3.68652,13 7,13 Z M3.75098,5.32278 C3.64893,5.19142 3.74268,5 3.90869,5 L10.09131,5 C10.25732,5 10.35107,5.19142 10.24902,5.32278 L7.15771,9.29703 C7.07764,9.39998 6.92236,9.39998 6.84229,9.29703 L3.75098,5.32278 Z"></path></svg></span>Type</th><td><span class="selected-value select-value-color-red">Lecture</span></td></tr><tr class="property-row property-row-file"><th><span class="icon property-icon"><svg viewBox="0 0 14 14" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" class="typesFile"><path d="M5.94578,14 C4.62416,14 3.38248,13.4963 2.44892,12.585 C1.514641,11.6736 1,10.4639 1,9.17405 C1.00086108,7.88562 1.514641,6.67434 2.44892,5.76378 L7.45612,0.985988 C8.80142,-0.327216 11.1777,-0.332396 12.5354,0.992848 C13.9369,2.36163 13.9369,4.58722 12.5354,5.95418 L8.03046,10.2414 C7.16278,11.0877 5.73682,11.0894 4.86024,10.2345 C3.98394,9.37789 3.98394,7.98769 4.86024,7.1327 L6.60422,5.4317 L7.87576,6.67196 L6.13177,8.37297 C6.01668,8.48539 6.00003,8.61545 6.00003,8.68335 C6.00003,8.75083 6.01668,8.88103 6.13177,8.99429 C6.36197,9.21689 6.53749,9.21689 6.76768,8.99429 L11.2707,4.70622 C11.9645,4.03016 11.9645,2.91757 11.2638,2.23311 C10.5843,1.57007 9.40045,1.57007 8.72077,2.23311 L3.71342,7.0109 C3.12602,7.58406 2.79837,8.35435 2.79837,9.17405 C2.79837,9.99459 3.12602,10.7654 3.72045,11.3446 C4.90947,12.5062 6.98195,12.5062 8.17096,11.3446 L10.41911,9.15165 L11.6906,10.3919 L9.4425,12.585 C8.50808,13.4963 7.2664,14 5.94578,14 Z"></path></svg></span>Materials</th><td><span style="margin-right:6px"><a href="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/20220125-slides.pdf">20220125-slides.pdf</a></span><span style="margin-right:6px"><a href="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/20220127-slides.pdf">20220127-slides.pdf</a></span></td></tr><tr class="property-row property-row-checkbox"><th><span class="icon property-icon"><svg viewBox="0 0 14 14" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" class="typesCheckbox"><path d="M0,3 C0,1.34314 1.34326,0 3,0 L11,0 C12.6567,0 14,1.34314 14,3 L14,11 C14,12.6569 12.6567,14 11,14 L3,14 C1.34326,14 0,12.6569 0,11 L0,3 Z M3,1.5 C2.17139,1.5 1.5,2.17157 1.5,3 L1.5,11 C1.5,11.8284 2.17139,12.5 3,12.5 L11,12.5 C11.8286,12.5 12.5,11.8284 12.5,11 L12.5,3 C12.5,2.17157 11.8286,1.5 11,1.5 L3,1.5 Z M2.83252,6.8161 L3.39893,6.27399 L3.57617,6.10425 L3.92334,5.77216 L4.26904,6.10559 L4.44531,6.27582 L5.58398,7.37402 L9.28271,3.81073 L9.45996,3.64008 L9.80664,3.3056 L10.1538,3.63989 L10.3311,3.81067 L10.8936,4.35303 L11.0708,4.52399 L11.4434,4.88379 L11.0708,5.24353 L10.8936,5.41437 L6.1084,10.0291 L5.93115,10.2 L5.58398,10.5344 L5.23682,10.2 L5.05957,10.0292 L2.83057,7.87946 L2.65283,7.70801 L2.27832,7.34674 L2.6543,6.98694 L2.83252,6.8161 Z"></path></svg></span>Reviewed</th><td><div class="checkbox checkbox-off"></div></td></tr><tr class="property-row property-row-date"><th><span class="icon property-icon"><svg viewBox="0 0 14 14" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" class="typesDate"><path d="M10.8889,5.5 L3.11111,5.5 L3.11111,7.05556 L10.8889,7.05556 L10.8889,5.5 Z M12.4444,1.05556 L11.6667,1.05556 L11.6667,0 L10.1111,0 L10.1111,1.05556 L3.88889,1.05556 L3.88889,0 L2.33333,0 L2.33333,1.05556 L1.55556,1.05556 C0.692222,1.05556 0.00777777,1.75556 0.00777777,2.61111 L0,12.5 C0,13.3556 0.692222,14 1.55556,14 L12.4444,14 C13.3,14 14,13.3556 14,12.5 L14,2.61111 C14,1.75556 13.3,1.05556 12.4444,1.05556 Z M12.4444,12.5 L1.55556,12.5 L1.55556,3.94444 L12.4444,3.94444 L12.4444,12.5 Z M8.55556,8.61111 L3.11111,8.61111 L3.11111,10.1667 L8.55556,10.1667 L8.55556,8.61111 Z"></path></svg></span>Due</th><td></td></tr><tr class="property-row property-row-text"><th><span class="icon property-icon"><svg viewBox="0 0 14 14" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" class="typesText"><path d="M7,4.56818 C7,4.29204 6.77614,4.06818 6.5,4.06818 L0.5,4.06818 C0.223858,4.06818 0,4.29204 0,4.56818 L0,5.61364 C0,5.88978 0.223858,6.11364 0.5,6.11364 L6.5,6.11364 C6.77614,6.11364 7,5.88978 7,5.61364 L7,4.56818 Z M0.5,1 C0.223858,1 0,1.223858 0,1.5 L0,2.54545 C0,2.8216 0.223858,3.04545 0.5,3.04545 L12.5,3.04545 C12.7761,3.04545 13,2.8216 13,2.54545 L13,1.5 C13,1.223858 12.7761,1 12.5,1 L0.5,1 Z M0,8.68182 C0,8.95796 0.223858,9.18182 0.5,9.18182 L11.5,9.18182 C11.7761,9.18182 12,8.95796 12,8.68182 L12,7.63636 C12,7.36022 11.7761,7.13636 11.5,7.13636 L0.5,7.13636 C0.223858,7.13636 0,7.36022 0,7.63636 L0,8.68182 Z M0,11.75 C0,12.0261 0.223858,12.25 0.5,12.25 L9.5,12.25 C9.77614,12.25 10,12.0261 10,11.75 L10,10.70455 C10,10.4284 9.77614,10.20455 9.5,10.20455 L0.5,10.20455 C0.223858,10.20455 0,10.4284 0,10.70455 L0,11.75 Z"></path></svg></span>Student</th><td></td></tr></tbody></table></header><div class="page-body"><h3 id="8b8f942c-6694-4970-bf78-026090c163c4" class="">Review from Class 1</h3><ul id="c6c72890-1151-4fba-ae27-921e21c6fd4e" class="bulleted-list"><li style="list-style-type:disc">The definition of an OS is ambiguous.<ul id="005e1c47-4151-447f-ab8c-11a79d9097fc" class="bulleted-list"><li style="list-style-type:circle">Does the OS include the Drivers? The harware APIs? The GUI/Windowing system?</li></ul></li></ul><ul id="a005769d-fe5f-4faa-b137-71e60342e5c4" class="bulleted-list"><li style="list-style-type:disc">OS have the following Roles:<ul id="1ffdbee5-ae50-4622-bd3b-c8479eb5314d" class="bulleted-list"><li style="list-style-type:circle">Referee<ul id="f234ae53-f5b4-4b2e-98c8-6e6e73b066b6" class="bulleted-list"><li style="list-style-type:square">The decide how to divide limited resources among programs<ul id="e45aa935-4ea7-4c05-af43-ff2f198aa5b4" class="bulleted-list"><li style="list-style-type:disc">time</li></ul><ul id="5746183c-367a-4ec2-b734-1df0286bc6da" class="bulleted-list"><li style="list-style-type:disc">memory</li></ul><ul id="aca1fc22-ebf1-41b4-82aa-eea843874871" class="bulleted-list"><li style="list-style-type:disc">permission levels</li></ul></li></ul></li></ul><ul id="fa0b0657-e19e-4d87-86a1-b42ddd4b9e80" class="bulleted-list"><li style="list-style-type:circle">Illusionist<ul id="6b66b18a-b526-4a84-8d41-a19cdce2c1f7" class="bulleted-list"><li style="list-style-type:square">The OS gives the illusion that each program has access to the hardware solely</li></ul></li></ul><ul id="6802fc6d-2a68-4b8a-9267-dd618207f868" class="bulleted-list"><li style="list-style-type:circle">Glue<ul id="f47733a6-dc8d-4b6c-b9d9-66f4e48b9c78" class="bulleted-list"><li style="list-style-type:square">We dont want every program providing its own implementation of certain services. Therefore the OS provides its own implementation and glues the programs with these OS provided services</li></ul></li></ul></li></ul><ul id="e7bae247-e12c-49bf-af66-67d69e6fbdbc" class="bulleted-list"><li style="list-style-type:disc">Process Virtual Machine<ul id="cd76994b-a474-418b-b0bd-9c7f59331449" class="bulleted-list"><li style="list-style-type:circle">Thread ~ Processor</li></ul><ul id="13965172-8d43-45ba-8183-d432bf1d790f" class="bulleted-list"><li style="list-style-type:circle">Address Space ~ Memory</li></ul><ul id="7583fc49-d466-443c-be3a-543e8ed1c48a" class="bulleted-list"><li style="list-style-type:circle">Files ~ Devices</li></ul></li></ul><ul id="1f060570-efd0-4d20-9249-31d250505365" class="bulleted-list"><li style="list-style-type:disc">Basic Hardware Support for OSes:<ul id="4ae5619a-f8d6-4028-87ca-0350a9109ece" class="bulleted-list"><li style="list-style-type:circle">Kernel vs. User Mode</li></ul><ul id="a87bce19-31eb-4c36-a1c8-9ff6efd2082f" class="bulleted-list"><li style="list-style-type:circle">Address Translation</li></ul><ul id="71898a16-b548-4349-919a-e6cebcdb87e8" class="bulleted-list"><li style="list-style-type:circle">Exceptions: Hardware jumps to OS on certain events</li></ul></li></ul><h3 id="64e9c65e-3ac6-4893-88cd-c569bfb6eb51" class="">Exception vs Mode Switch</h3><ul id="be5c60ae-11f1-4844-aa20-84709d2ddd2b" class="bulleted-list"><li style="list-style-type:disc">Mode Switch: Go from kernel mode to user mode or vice versa. </li></ul><ul id="c7aadcf2-8a15-4d90-8a60-099514eda9b8" class="bulleted-list"><li style="list-style-type:disc">Exception: Hardware triggers OS function (”HANDLER”) to run (to handle)<ul id="8fa18205-bf34-4169-998f-193da5eafe11" class="bulleted-list"><li style="list-style-type:circle">Will switch from user to kernel mode (if necessary)</li></ul><ul id="c07e92b0-399e-4165-a698-5a4a00d1b720" class="bulleted-list"><li style="list-style-type:circle">Finishing exception handler (usually) forces switch back to USER MODE.</li></ul></li></ul><h1 id="515497d8-cc27-4451-8a3c-66fb515a9372" class="">SYSTEM CALLS via SYS WRAPPER</h1><h2 id="d0e45c63-4fc4-4727-ad5d-f361a1e5d41d" class="">Write Syscall and Layers</h2><p id="c1311dc5-8d60-4c7b-8b32-2d540ffbf56d" class="">There are some system calls that cannot simply be written in C. In x86 you run a special syscall wrapper that triggers an exception in order to run kernel code.</p><pre id="6e59701c-387c-4001-9ebf-012af8fe7576" class="code"><code>#include &quot;user.h&quot;
int main(void) {
	write(1, &quot;Hello, World!&quot;, 13); // function call interface
	exit();
}

// converted to assembly w.r.t. 32-bit x86 calling convention:
pushl $13
pushl $string_address
pushl $1
call write</code></pre><figure id="16410d6a-32bf-43b9-8d4e-4079abb8ca4a" class="image"><a href="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_3.41.03_PM.png"><img style="width:1134px" src="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_3.41.03_PM.png"/></a></figure><figure id="f50e797a-a93b-40ee-b7ba-659c41dafa42" class="image"><a href="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_5.08.49_PM.png"><img style="width:994px" src="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_5.08.49_PM.png"/></a></figure><ul id="9fdb6632-324f-4f47-bf80-a9818bb24269" class="bulleted-list"><li style="list-style-type:disc">In xv6, You have a interrupt table (which is an array) <ul id="fc05c72d-510e-4bf0-934f-9c719ae8fa13" class="bulleted-list"><li style="list-style-type:circle"><code>write()</code> : syscall wrapper (uses <code>int $64</code>)</li></ul></li></ul><ul id="c825a6d6-faf7-4754-b002-697700e161ae" class="bulleted-list"><li style="list-style-type:disc">The interrupt table switch the stack pointer to the <code>vector64</code> assembly function<ul id="0150ddcc-80c4-4dfc-be4b-153bff751156" class="bulleted-list"><li style="list-style-type:circle">This function saves the registers, which is what we call the trapframe</li></ul><ul id="378bb0f1-788c-4cdb-b810-dc50bf6fef13" class="bulleted-list"><li style="list-style-type:circle">the function then calls the C function <code>trap()</code> </li></ul></li></ul><ul id="ae66562b-9865-477a-a81b-25e640efa4a8" class="bulleted-list"><li style="list-style-type:disc">The <code>trap()</code> function uses the trap number from the trapframe and calls the correct <code>syscall()</code> </li></ul><ul id="6020bdf9-fe69-4850-84dd-1c313f05c312" class="bulleted-list"><li style="list-style-type:disc">uses the number (<code>write()</code> : 64) from the syscall wrapper (which has now been passed down through the call stack into <code>%eax</code>) to call the correct system function</li></ul><ul id="2ef75760-f018-43eb-8ddf-7e5ca2b40c62" class="bulleted-list"><li style="list-style-type:disc">Now <code>sys_write()</code> has access to the arguments from the user stack and performs the writing process</li></ul><ul id="52d85cdd-b5d1-4162-ab96-8070b5b71b26" class="bulleted-list"><li style="list-style-type:disc">pop up the call stack, and restore to the caller’s process state.</li></ul><h3 id="b965d759-48a7-491e-b975-7ba2629fb9af" class="">User Mode </h3><p id="b4f37667-ea22-49af-8f11-eaf88ee21a72" class="">How does the user’s program handle calling system functions?</p><pre id="5a27289b-b6e6-4529-9654-27ca8629cd0d" class="code"><code>write(1, &quot;Hello, World!\n&quot;, 14); // from main.c

...

#define SYS_write    16       // from syscall.h / trap.h
...
#define T_SYSCALL    64</code></pre><pre id="b641f5a8-b24e-419e-a9ec-6e9b86058b07" class="code"><code>// from usys.S
#define SYSCALL(name)...

// Partial, after macro replacement
.globl write
write:
	movl $SYS_write, %eax
	int  $T_SYSCALL
	ret</code></pre><h3 id="36c4ca12-f8ed-4410-bdbc-336b63b6c6b8" class="">Interrupt Descriptor Table / Interrupt Table Indirection</h3><ul id="74e2c296-69b9-4c0a-b76c-cea4afa7cf89" class="bulleted-list"><li style="list-style-type:disc">A table of <code>structs</code> that contains:</li></ul><pre id="001d6691-f858-4feb-85de-3f7c7b9621c3" class="code"><code>// trap.c (ran on boot)
...
lidt(idt, sizeof(idt));
...
SETGATE(idt[T_SYSCALL], 1, SEG_KCODE&lt;&lt;3, vectors[T_SYSCALL], DPL_USER);

// vectors.S
vector64:
	pushl $0
	pushl $64      // Used for type of exception
	jmp alltraps   // Jump to the handler for all exceptions 

// trapasm.S
alltraps:
	...
	call trap
	...
	iret           // return from interrupt

// trap.c (run later)
void trap(struct trapframe *tf){
	...
} </code></pre><h3 id="ffac440f-a39b-4bb2-8f24-1ded44e7b910" class="">The trap function</h3><p id="aa5cae11-e86c-4639-b405-dfd9b6d4b16b" class="">Our <code>trapframe</code> contains all the registers, including the return address for the OS to go back to user mode.</p><pre id="b774a72a-7082-459f-9daf-deb78245382a" class="code"><code>void trap(struct trapframe *tf) {
	if(tf-&gt;trapno == T_SYSCALL) {
		if(myproc()-&gt;killed)    // myproc() represents the currently running process
			exit();               // if program is no longer running, stop 
		myproc()-&gt;tf = tf;      // save register call
		syscall();              // do the system call using myproc()-&gt;tf
    if(myproc()-&gt;killed)    // if its been killed, dont return the the caller
			exit();
		return;
	}
	...
}</code></pre><h3 id="4463721e-5adf-4380-9ae4-b439dfbe609e" class="">The syscall function</h3><p id="5d9ffe5f-380c-4c6b-8324-7d51c72bbdf9" class="">x86 has an array of pointers that point to the numbered system call functions. They are indexed by the syscall number respectively.</p><pre id="0ee9cb38-7499-4eec-8ba1-6a0728afbc98" class="code"><code>static int (*syscalls[])(void) = {
...
[SYS_write] sys_write,          // &#x27;[number] value/pointer,&#x27;
...
};
...
void syscall(void){             // The function implementation pointed to
	...
	num = curproc-&gt;tf-&gt;eax        // grab the syscall number (saved with asm)
	// If the syscall number corresponds to a valid syscall function
	if(num &gt; 0 &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) {
		// change the number to the function pointer for that syscall function
		curproc-&gt;tf-&gt;eax = syscalls[num](); 
	}
	else { ... }</code></pre><pre id="70a019c3-2567-4ce7-9db4-280906641256" class="code"><code>int sys_write(void) {
	{
		struct file *f;        // these are the arguments provided from the user
		int n;
		char *p;
		
		// UTILITY FUNCTION that reads args from user stack and returns -1 on error.
		// 32bit x86 calling convention puts all args on stack
		if(argfd(0, 0, &amp;f) &lt; 0 || argint(2, &amp;n) &lt; 0 || argptr(1, &amp;p, n) &lt; 0)
			return -1;
		return filewrite(f, p, n); // call the real write function</code></pre><h2 id="342aa105-0f4a-42a5-8ee6-18e18d6b3099" class="">Address Translation</h2><p id="6e0ef308-86f6-44e8-817b-0b90076b9007" class="">
</p><figure id="c5dd91fa-d89f-45ec-9ee1-f57fb7f05c2c" class="image"><a href="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_6.55.34_PM.png"><img style="width:2536px" src="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_6.55.34_PM.png"/></a></figure><ul id="fff5e81d-58c0-4e07-9f5d-d9b1167b7203" class="bulleted-list"><li style="list-style-type:disc">Kernel Stack(s) is allocated in Free Memory </li></ul><ul id="e19226d8-328d-494a-87a9-39654a008a54" class="bulleted-list"><li style="list-style-type:disc">CPU switches between stacks during exception, interrupt, etc; Stores location to task state selector</li></ul><ul id="708454a8-eee7-453e-90e3-d5c55a319ad1" class="bulleted-list"><li style="list-style-type:disc">One kernel stack per user thread (plus extra stack for switching threads)</li></ul><ul id="a3d5ddfc-bfe4-40f0-affb-23c43a6efd7e" class="bulleted-list"><li style="list-style-type:disc">Special register for exception handler (set on thread/process switch) that saves old PC, etc.</li></ul><p id="6b4b0fb7-e1bb-4f17-8336-c51299f2519a" class="">
</p><h2 id="26bb2835-b7ec-42f5-9bb1-152f038d6b8a" class="">Non-System call exceptions</h2><ul id="bb8a9c64-10e7-4591-9971-2f6bd67b1c17" class="bulleted-list"><li style="list-style-type:disc">Timer Interrupt — Using ticks from clock<ul id="af8929da-e0ac-4e04-a6b9-afc784042bc7" class="bulleted-list"><li style="list-style-type:circle">Dont let a program hog CPU time</li></ul><ul id="d3591542-13a5-475c-8764-a74b618d7be2" class="bulleted-list"><li style="list-style-type:circle">Check for programs waiting to run</li></ul></li></ul><ul id="d7503272-92f4-493f-af82-625e78671c2c" class="bulleted-list"><li style="list-style-type:disc">Faults<ul id="28cce936-ccd2-4c2f-a776-fb5f2802c108" class="bulleted-list"><li style="list-style-type:circle">things like divide by zero. Stop illegal things from happening and kill the process</li></ul></li></ul><ul id="30662a75-e7ff-4247-86ab-13856e16ba93" class="bulleted-list"><li style="list-style-type:disc">I/O<ul id="e31030e6-7314-432d-bdb1-63e46a36bc02" class="bulleted-list"><li style="list-style-type:circle">Interrupt the program to use I/O</li></ul><p id="e02b06be-c077-4946-8ce1-89dd0727fd74" class="">
</p></li></ul><h2 id="92147c75-4191-4c4d-8634-0fb178e02823" class="">Time Multiplexing</h2><p id="880c9396-7752-4777-b25f-d5a9b9d63603" class="">Sharing time between multiple user spaces (programs) by switching contexts when needed.</p><ul id="6d0c904f-1116-4786-a49d-5d703d4963f4" class="bulleted-list"><li style="list-style-type:disc">Save the old context</li></ul><ul id="0dceb566-7dbe-4065-a919-50f3613844fd" class="bulleted-list"><li style="list-style-type:disc">load the new one</li></ul><ul id="12b96037-b106-4902-8180-03d9355c1166" class="bulleted-list"><li style="list-style-type:disc">start running new process</li></ul><h3 id="ab62221c-6d4b-4d57-a136-cc61c187719f" class="">Context</h3><ul id="42f2020e-ae71-45b8-ae73-edd4c2590ebf" class="bulleted-list"><li style="list-style-type:disc">All register values</li></ul><ul id="b436cca9-d967-4b12-be90-fc6488f9edd0" class="bulleted-list"><li style="list-style-type:disc">Condition code values</li></ul><ul id="3faf57bc-c2ea-41e8-a06a-2d7b265351f6" class="bulleted-list"><li style="list-style-type:disc">PC value</li></ul><ul id="aa992985-fe80-4a7c-a1a2-9bfed05ad160" class="bulleted-list"><li style="list-style-type:disc">address space → page table base pointer</li></ul><p id="e8eea152-8e4a-4b6c-b159-d894dca3addb" class="">When switching context, the old process saves its registers via the exception handler into the <code>trapframe</code> on the processes’ respective kernel stack</p><h3 id="ee6ecf20-38d2-474e-a897-e2615b75b1c5" class="">Context Switch</h3><figure id="15960999-39f8-46e3-afb4-a9d3a1265cad" class="image"><a href="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_7.48.04_PM.png"><img style="width:2790px" src="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_7.48.04_PM.png"/></a></figure><h3 id="674768dd-7aad-4f36-b272-f6e223854d4b" class="">Thread / Process control block</h3><ul id="2284039c-a192-41ef-baf8-07d185539570" class="bulleted-list"><li style="list-style-type:disc">need to have pointer to saved registers for the thread</li></ul><ul id="04fd239d-6539-4ad2-8072-27b5c023556f" class="bulleted-list"><li style="list-style-type:disc">Thread Control Block: struct or class with that information</li></ul><ul id="495bc190-00aa-4979-98c4-caa6823d9fbe" class="bulleted-list"><li style="list-style-type:disc">Process Control Blocks: Same but for the process<ul id="9169fb2b-1c91-4f7b-a24f-9582499f70a5" class="bulleted-list"><li style="list-style-type:circle">xv6: <code>struct proc</code></li></ul><ul id="725872df-0236-475b-beb6-2d139905b1ed" class="bulleted-list"><li style="list-style-type:circle">xv6: doubles as thread control block (single thread processes)</li></ul></li></ul><p id="89df2663-a27e-4654-891c-6a67a4872b6f" class="">
</p><figure id="be66ca38-fc18-4ecb-abea-7791fac7efd6" class="image"><a href="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_8.13.58_PM.png"><img style="width:2980px" src="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_8.13.58_PM.png"/></a></figure><h3 id="e0e1ca5f-d16f-4f70-ae4d-d0de4f58f163" class=""><code>swtch</code> prototype</h3><pre id="1d3df1db-16ed-4ebe-a680-d2674161577e" class="code"><code>void swtch(struct context **old, struct context *new);</code></pre><ul id="01a80ec1-dd80-442d-9b3b-33858b055afb" class="bulleted-list"><li style="list-style-type:disc">Save current context into <code>*old</code><ul id="76d669e2-8c72-4854-91c9-92e8de4bf068" class="bulleted-list"><li style="list-style-type:circle">doing the double pointer, we allocate the space for the <code>x-&gt;context</code> on the <code>struct proc</code></li></ul></li></ul><ul id="ea07cf83-2673-41b1-8ed9-df9050e87d07" class="bulleted-list"><li style="list-style-type:disc">start running context from <code>new</code></li></ul><ul id="9f971647-5bca-4319-adf4-dd369442c0a8" class="bulleted-list"><li style="list-style-type:disc">TRICK: <code>struct context*</code> is the thread’s stack pointer</li></ul><ul id="b8b59d6e-1535-4d2b-bb03-a02af45898c0" class="bulleted-list"><li style="list-style-type:disc">top of stack contains saved registers, etc....</li></ul><figure id="35a8fda8-d328-42e5-84cc-fd3fce69d8ea" class="image"><a href="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_8.16.30_PM.png"><img style="width:2662px" src="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_8.16.30_PM.png"/></a></figure><ul id="1f0b0684-ee25-4cfd-be3e-ede5a5ac98af" class="bulleted-list"><li style="list-style-type:disc">When we switch, it is as if we are returning from the previous <code>swtch</code> call.</li></ul><h3 id="1bbc2f50-2c0f-4a94-9561-b9bdf8f87748" class="">Starting Proc as a Thread</h3><div id="26ec9dac-1df1-4828-aa80-74141092caa1" class="column-list"><div id="cb4f2d8c-36dd-4563-8ad7-cb4d6fe83962" style="width:50%" class="column"><p id="76709480-37cb-4629-a69b-9e9662b4e814" class="">Creating a new Thread: <code>allocproc</code></p><p id="01a3d8d0-9375-4780-96c3-f68640fd8964" class="">
</p><p id="bc4fe642-19f1-41af-9792-5b634198fa34" class="">We create a new kernel stack that appears as if it starts running like it is returning from a previous <code>swtch</code> call.</p></div><div id="97fd30cc-9220-474d-a077-4f441437ca15" style="width:50%" class="column"><figure id="1358db29-8e58-4c54-9038-88401488ba4e" class="image"><a href="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_8.54.08_PM.png"><img style="width:399px" src="Exceptions%20&amp;%20Context%20Switching%20ec98067a51804a0196c7f80acb71d903/Screen_Shot_2022-01-30_at_8.54.08_PM.png"/></a></figure></div></div><pre id="dc4aaa4e-5148-482d-93fb-703f17508ca2" class="code"><code>static struct proc* allocproc(void) {
	...
	// new stack pointer
	sp = p−&gt;kstack + KSTACKSIZE; 
	
	// Leave room for trap frame. 
	sp −= sizeof *p−&gt;tf;
	p−&gt;tf = (struct trapframe*)sp;
	
	// Set up new context to start executing at forkret, 
	// which returns to trapret.
	sp −= 4;
	*(uint*)sp = (uint)trapret;

	// saved registers, etc. Same as if swtch has happened.
	sp −= sizeof *p−&gt;context;
	p−&gt;context = (struct context*)sp; 
	memset(p−&gt;context, 0, sizeof *p−&gt;context); 
	p−&gt;context−&gt;eip = (uint)forkret;
	...
}</code></pre><p id="7a89aafb-f43c-45fa-8c0d-879c877182c1" class="">
</p><h2 id="50486798-0daa-4401-b85c-2e9c6ea6e7e7" class="">Process Control Block </h2><p id="627301a0-a5ee-4924-a194-19078c1284f4" class="">A data structure to represent a process itself</p><p id="51afd739-2ea8-4028-8c2d-ec6294cffe67" class="">xv6: <code>struct proc</code></p><pre id="db9d1655-3220-45c9-9bd4-4249f3343136" class="code"><code>struct proc {
	uint sz;                    // Size of process memory (bytes)
	pde_t* pgdir;               // Page table
	char *kstack;               // Bottom of kernel stack for this process
	enum procstate state;       // Process state
	int pid;                    // Process ID
	struct proc *parent;        // Parent process
	struct trapframe *tf;       // Trap frame for current syscall
	struct context *context;    // swtch() here to run process
	void *chan;                 // If non-zero, sleeping on chan
	int killed;                 // If non-zero, have been killed
	struct file *ofile[NOFILE]; // Open files
	struct inode *cwd;          // Current directory
	char name[16];              // Process name (debugging)
};

enum procstate {
	UNUSED, EMBRYO, SLEEPING, RUNNABLE, RUNNING, ZOMBIE
};</code></pre><p id="da7dc194-bb63-45dc-8f1e-f5ad36dd327f" class="">
</p></div></article></body></html>